<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Property Details – Livyro</title>

<!-- SUPABASE LOAD FIRST -->
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>

<style>
body {
    margin: 0;
    font-family: Arial, sans-serif;
    background: #faf7ff;
}

/* HERO IMAGE */
.hero {
    width: 100%;
    height: 320px;
    background: #ddd;
    border-bottom: 4px solid #6A0DAD;
}
.hero img {
    width: 100%;
    height: 320px;
    object-fit: cover;
}

/* CONTENT */
.container {
    max-width: 1100px;
    margin: 30px auto;
    padding: 0 20px;
    display: flex;
    gap: 30px;
}

.left { flex: 3; }

.left h1 {
    font-size: 32px;
    margin-bottom: 10px;
    color: #4a007e;
}

.detail-line {
    font-size: 16px;
    margin: 6px 0;
    color: #555;
}

.section-title {
    margin-top: 30px;
    font-size: 22px;
    color: #6A0DAD;
    font-weight: bold;
}

.amenities {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin-top: 10px;
}

.amenity {
    padding: 8px 14px;
    background: #eee;
    border-radius: 8px;
    font-size: 14px;
}

/* RIGHT SIDE */
.right {
    flex: 1.2;
    position: sticky;
    top: 20px;
}

.contact-box {
    background: #fff;
    padding: 20px;
    border-radius: 16px;
    box-shadow: 0 4px 20px rgba(106, 13, 173, 0.12);
    border-left: 6px solid #6A0DAD;
}

.contact-box button {
    width: 100%;
    padding: 12px;
    background: #6A0DAD;
    color: #fff;
    border: none;
    border-radius: 999px;
    cursor: pointer;
    margin-top: 12px;
    font-size: 16px;
}
</style>
</head>

<body>

<div class="hero">
<img id="heroImg" src="">
</div>

<div class="container">

<div class="left">
<h1 id="title">Loading...</h1>

<div class="detail-line" id="city"></div>
<div class="detail-line" id="bhk"></div>
<div class="detail-line" id="size"></div>
<div class="detail-line" id="rent"></div>

<h2 class="section-title">Description</h2>
<p id="description"></p>

<h2 class="section-title">Amenities</h2>
<div id="amenities" class="amenities"></div>

<h2 class="section-title">Similar Properties</h2>
<div id="similarGrid"></div>
</div>

<div class="right">
<div class="contact-box">
<h3>Contact Owner</h3>
<p id="ownerName"></p>
<p id="ownerEmail"></p>
<p id="ownerPhone"></p>

<button onclick="alert('Enquiry system active on Rentals page!')">
Send Enquiry
</button>

<button id="saveBtn" style="margin-top:10px;background:#ff4da6;">
♡ Save Home
</button>
</div>
</div>

</div>

<script>
// ---------------------------
// SUPABASE CLIENT
// ---------------------------
if (!window.supabase) {
  alert("Supabase not loaded. Check internet.");
}

const supabaseUrl = "https://ehzwbbypvccuhfhvukpp.supabase.co";
const supabaseAnonKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVoendiYnlwdmNjdWhmaHZ1a3BwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEzNTQzMzMsImV4cCI6MjA4NjkzMDMzM30.JPsDBtJVw-lrlr8Y2ipioNQtc80DZ0v1wKcPtz0ixzI";

const { createClient } = window.supabase;
const supabase = createClient(supabaseUrl, supabaseAnonKey);

// ---------------------------
// GET PROPERTY ID
// ---------------------------
const params = new URLSearchParams(window.location.search);
const propertyId = params.get("id");

// Tenant session
const tenant = JSON.parse(localStorage.getItem("livyro_tenant"));
const saveBtn = document.getElementById("saveBtn");

// ---------------------------
// LOAD PROPERTY DETAILS
// ---------------------------
async function loadProperty() {
    const { data, error } = await supabase
        .from("properties")
        .select("*, owners(name,email,phone)")
        .eq("id", propertyId)
        .maybeSingle();

    if (error || !data) return;

    const p = data;

    document.getElementById("heroImg").src = p.images?.[0] || "https://via.placeholder.com/1200x400";
    document.getElementById("title").textContent = p.title;
    document.getElementById("city").textContent = p.city;
    document.getElementById("bhk").textContent = p.bhk + " BHK";
    document.getElementById("size").textContent = p.size + " sqft";
    document.getElementById("rent").textContent = "₹" + p.rent;
    document.getElementById("description").textContent = p.description;

    document.getElementById("ownerName").textContent = p.owners?.name || "Unknown";
    document.getElementById("ownerEmail").textContent = p.owners?.email || "-";
    document.getElementById("ownerPhone").textContent = p.owners?.phone || "-";

    loadSimilar(p.city, p.id);
    checkSaved();
}

// ---------------------------
// LOAD SIMILAR PROPERTIES
// ---------------------------
async function loadSimilar(city, excludeId) {
    const { data } = await supabase
        .from("properties")
        .select("*")
        .eq("city", city)
        .neq("id", excludeId)
        .limit(3);

    const grid = document.getElementById("similarGrid");

    if (!data || !data.length) {
        grid.innerHTML = "<p>No similar properties found.</p>";
        return;
    }

    data.forEach(p => {
        const card = document.createElement("div");
        card.className = "similar-card";

        card.innerHTML = `
            <img src="${p.images?.[0] || 'https://via.placeholder.com/300'}">
            <h4>${p.title}</h4>
            <p>${p.city} • ${p.size} sqft</p>
            <p>₹${p.rent} / month</p>
            <a href="property-details.html?id=${p.id}" style="color:#6A0DAD;font-weight:bold;">View</a>
        `;

        grid.appendChild(card);
    });
}

// ---------------------------
// CHECK IF SAVED
// ---------------------------
async function checkSaved() {
    if (!tenant) return;

    const { data } = await supabase
        .from("saved_homes")
        .select("*")
        .eq("tenant_id", tenant.id)
        .eq("property_id", propertyId)
        .maybeSingle();

    if (data) {
        saveBtn.textContent = "❤️ Saved";
        saveBtn.style.background = "#d4006e";
    }
}

// ---------------------------
// SAVE / UNSAVE
// ---------------------------
saveBtn.addEventListener("click", async () => {
    if (!tenant) {
        alert("Please login as a tenant to save homes.");
        window.location.href = "tenant-login.html";
        return;
    }

    const { data: existing } = await supabase
        .from("saved_homes")
        .select("*")
        .eq("tenant_id", tenant.id)
        .eq("property_id", propertyId)
        .maybeSingle();

    if (existing) {
        await supabase.from("saved_homes").delete().eq("id", existing.id);
        saveBtn.textContent = "♡ Save Home";
        saveBtn.style.background = "#ff4da6";
        return;
    }

    await supabase.from("saved_homes").insert({
        tenant_id: tenant.id,
        property_id: propertyId
    });

    saveBtn.textContent = "❤️ Saved";
    saveBtn.style.background = "#d4006e";
});

// ---------------------------
// INITIAL LOAD
// ---------------------------
loadProperty();
</script>

</body>
</html>
