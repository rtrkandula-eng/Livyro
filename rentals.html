<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Livyro Rentals</title>

  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: "Poppins", sans-serif;
      background: #f5f7fa;
    }

    /* HEADER */
    .header {
      background: #ffffff;
      padding: 16px 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 10px rgba(0,0,0,0.08);
      position: sticky;
      top: 0;
      z-index: 20;
    }

    .logo {
      font-size: 24px;
      font-weight: 700;
      color: #6A0DAD;
      cursor: pointer;
    }

    .nav-buttons button {
      margin-left: 12px;
      padding: 10px 18px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font-size: 14px;
    }

    .btn-outline {
      background: #fff;
      border: 1px solid #6A0DAD;
      color: #6A0DAD;
    }

    .btn-primary {
      background: #6A0DAD;
      color: white;
    }

    header.page-title {
      background: #6a0dad;
      padding: 20px;
      color: white;
      text-align: center;
      font-size: 24px;
      font-weight: 600;
    }

    .container {
      max-width: 1100px;
      margin: 20px auto 40px;
      padding: 0 10px;
    }

    /* SEARCH BAR */
    .search-box {
      background: #ffffff;
      padding: 20px;
      border-radius: 18px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.08);
      margin-bottom: 25px;

      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 22px;
      align-items: center;
    }

    .input-group {
      position: relative;
      display: flex;
      align-items: center;
      background: #f3f0f8;
      padding: 10px 14px;
      border-radius: 50px;
      border: 1px solid #e0d7f3;
    }

    .input-group .icon {
      font-size: 18px;
      margin-right: 10px;
      color: #6a0dad;
    }

    .input-group input,
    .input-group select {
      border: none;
      background: transparent;
      outline: none;
      width: 100%;
      font-size: 14px;
      font-family: "Poppins";
    }

    /* AUTOCOMPLETE DROPDOWN */
    .suggestions {
      position: absolute;
      top: 48px;
      left: 0;
      right: 0;
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      max-height: 200px;
      overflow-y: auto;
      display: none;
      z-index: 10;
    }

    .suggestions div {
      padding: 10px 14px;
      cursor: pointer;
      border-bottom: 1px solid #eee;
    }

    .suggestions div:hover {
      background: #f3f0f8;
    }

    .search-btn {
      background: #6a0dad;
      color: white;
      padding: 14px 20px;
      border: none;
      border-radius: 50px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: 0.2s;
    }

    .search-btn:hover {
      background: #5800b0;
      transform: translateY(-2px);
    }

    /* PROPERTY GRID */
    .properties {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 20px;
    }

    .card {
      background: white;
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 6px 20px rgba(0,0,0,0.08);
      transition: 0.25s ease;
      display: flex;
      flex-direction: column;
    }

    .card:hover {
      transform: translateY(-6px);
      box-shadow: 0 10px 28px rgba(0,0,0,0.12);
    }

    .card-img {
      position: relative;
    }

    .card-img img {
      width: 100%;
      height: 200px;
      object-fit: cover;
    }

    .badge {
      position: absolute;
      top: 12px;
      left: 12px;
      background: #6a0dad;
      color: white;
      padding: 6px 12px;
      border-radius: 50px;
      font-size: 12px;
      font-weight: 600;
    }

    .card-body {
      padding: 18px;
    }

    .price {
      font-size: 22px;
      font-weight: 700;
      color: #6a0dad;
      margin-bottom: 8px;
    }

    .location {
      font-size: 14px;
      color: #555;
      margin-bottom: 12px;
    }

    .details {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      font-size: 14px;
      color: #333;
      margin-bottom: 16px;
    }

    .details span {
      background: #f3f0f8;
      padding: 6px 10px;
      border-radius: 8px;
    }

    .view-btn {
      width: 100%;
      padding: 12px;
      background: #6a0dad;
      color: white;
      border: none;
      border-radius: 10px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: 0.2s;
    }

    .view-btn:hover {
      background: #5800b0;
    }

    /* MODALS (Login / Signup / Add Property) */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.55);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 50;
    }

    .modal-content {
      background: white;
      padding: 25px;
      width: 380px;
      max-width: 90%;
      border-radius: 16px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.2);
    }

    .modal-content h3 {
      margin-top: 0;
      margin-bottom: 12px;
      color: #2b2b2b;
    }

    .modal-content input,
    .modal-content select,
    .modal-content textarea {
      width: 100%;
      padding: 12px;
      margin-bottom: 12px;
      border-radius: 10px;
      border: 1px solid #ccc;
      font-size: 14px;
      font-family: inherit;
    }

    .modal-close {
      text-align: right;
      cursor: pointer;
      font-size: 18px;
      margin-bottom: 10px;
    }

    .modal-primary-btn {
      background: #6A0DAD;
      color: white;
      padding: 12px;
      width: 100%;
      border-radius: 10px;
      cursor: pointer;
      border: none;
      font-size: 15px;
      font-weight: 600;
    }

    .modal-link {
      text-align: center;
      margin-top: 10px;
      font-size: 14px;
    }

    .modal-link span {
      color: #6A0DAD;
      cursor: pointer;
      font-weight: 500;
    }

    /* TOAST */
    .toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: #6A0DAD;
      color: white;
      padding: 12px 18px;
      border-radius: 8px;
      display: none;
      font-size: 14px;
      z-index: 60;
    }
  </style>
</head>

<body>

<!-- HEADER -->
<div class="header">
  <div class="logo" onclick="window.location.href='index.html'">LIVYRO</div>
  <div class="nav-buttons" id="navButtons"></div>
</div>

<header class="page-title">Livyro Rentals</header>

<div class="container">

  <!-- SEARCH BAR -->
  <div class="search-box">

    <div class="input-group">
      <span class="icon">üìç</span>
      <input type="text" id="searchCity" placeholder="Search city (All India)" onkeyup="showCitySuggestions()">
      <div id="citySuggestions" class="suggestions"></div>
    </div>

    <div class="input-group">
      <span class="icon">üè†</span>
      <select id="filterType">
        <option value="">Property Type</option>
        <option value="Apartment">Apartment</option>
        <option value="Villa">Villa</option>
        <option value="Independent House">Independent House</option>
        <option value="Studio">Studio</option>
        <option value="Penthouse">Penthouse</option>
      </select>
    </div>

    <div class="input-group">
      <span class="icon">üõèÔ∏è</span>
      <select id="filterBHK">
        <option value="">BHK</option>
        <option value="1 BHK">1 BHK</option>
        <option value="2 BHK">2 BHK</option>
        <option value="3 BHK">3 BHK</option>
        <option value="4 BHK">4 BHK</option>
        <option value="5 BHK">5 BHK</option>
      </select>
    </div>

    <div class="input-group">
      <span class="icon">üí∞</span>
      <select id="filterBudget">
        <option value="">Budget</option>
        <option value="1000">‚Çπ1,000+</option>
        <option value="5000">‚Çπ5,000+</option>
        <option value="10000">‚Çπ10,000+</option>
        <option value="20000">‚Çπ20,000+</option>
        <option value="50000">‚Çπ50,000+</option>
        <option value="100000">‚Çπ1,00,000+</option>
        <option value="200000">‚Çπ2,00,000+</option>
        <option value="500000">‚Çπ5,00,000+</option>
      </select>
    </div>

    <div class="input-group">
      <span class="icon">üõãÔ∏è</span>
      <select id="filterFurnishing">
        <option value="">Furnishing</option>
        <option value="Fully Furnished">Fully Furnished</option>
        <option value="Semi Furnished">Semi Furnished</option>
        <option value="Unfurnished">Unfurnished</option>
      </select>
    </div>

    <button class="search-btn" onclick="applyFilters()">Search</button>

  </div>

  <!-- PROPERTY LIST -->
  <div id="properties" class="properties"></div>

</div>

<!-- LOGIN MODAL -->
<div class="modal" id="loginModal">
  <div class="modal-content">
    <div class="modal-close" onclick="closeLoginModal()">‚úñ</div>
    <h3>Owner Login</h3>

    <input type="email" id="loginEmail" placeholder="Email">
    <input type="password" id="loginPassword" placeholder="Password">

    <button class="modal-primary-btn" onclick="login()">Login</button>

    <div class="modal-link">
      New owner? <span onclick="switchToSignup()">Create account</span>
    </div>

    <p id="loginStatus"></p>
  </div>
</div>

<!-- SIGNUP MODAL -->
<div class="modal" id="signupModal">
  <div class="modal-content">
    <div class="modal-close" onclick="closeSignupModal()">‚úñ</div>
    <h3>Owner Sign Up</h3>

    <input type="email" id="signupEmail" placeholder="Email">
    <input type="password" id="signupPassword" placeholder="Password">

    <button class="modal-primary-btn" onclick="signup()">Create Account</button>

    <div class="modal-link">
      Already have an account? <span onclick="switchToLogin()">Login</span>
    </div>

    <p id="signupStatus"></p>
  </div>
</div>

<!-- ADD PROPERTY MODAL (OWNER ONLY, VERIFIED EMAIL) -->
<div class="modal" id="addModal">
  <div class="modal-content">
    <div class="modal-close" onclick="closeAddModal()">‚úñ</div>

    <h3>Add New Property</h3>

    <input type="text" id="addCity" placeholder="City">
    <select id="addBHK">
      <option value="">BHK</option>
      <option value="1">1 BHK</option>
      <option value="2">2 BHK</option>
      <option value="3">3 BHK</option>
      <option value="4">4 BHK+</option>
    </select>

    <input type="number" id="addRent" placeholder="Rent (‚Çπ)">
    <input type="number" id="addSize" placeholder="Size (sqft)">

    <select id="addFurnishing">
      <option value="">Furnishing</option>
      <option>Fully Furnished</option>
      <option>Semi Furnished</option>
      <option>Unfurnished</option>
    </select>

    <textarea id="addDescription" placeholder="Description"></textarea>

    <input type="file" id="addImageUpload" accept="image/*">
    <img id="addPreview" style="width:100%;border-radius:8px;margin-top:10px;display:none;">

    <button class="modal-primary-btn" onclick="addProperty()">Add Property</button>
    <p id="addStatus"></p>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
  const supabaseUrl = "https://ehzwbbypvccuhfhvukpp.supabase.co";
  const supabaseAnonKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVoendiYnlwdmNjdWhmaHZ1a3BwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEzNTQzMzMsImV4cCI6MjA4NjkzMDMzM30.JPsDBtJVw-lrlr8Y2ipioNQtc80DZ0v1wKcPtz0ixzI";
  const supabaseClient = supabase.createClient(supabaseUrl, supabaseAnonKey);

  let allProperties = [];
  let currentUser = null;

  const indianCities = [
    "Hyderabad", "Bengaluru", "Mumbai", "Delhi", "Chennai", "Pune",
    "Kolkata", "Ahmedabad", "Jaipur", "Lucknow", "Surat", "Indore",
    "Kochi", "Coimbatore", "Nagpur", "Visakhapatnam", "Bhopal"
  ];

  function showToast(msg) {
    const t = document.getElementById("toast");
    t.textContent = msg;
    t.style.display = "block";
    setTimeout(() => t.style.display = "none", 2500);
  }

  function showCitySuggestions() {
    let input = document.getElementById("searchCity").value.toLowerCase();
    let box = document.getElementById("citySuggestions");

    if (input.length < 1) {
      box.style.display = "none";
      return;
    }

    let matches = indianCities.filter(city =>
      city.toLowerCase().startsWith(input)
    );

    if (matches.length === 0) {
      box.style.display = "none";
      return;
    }

    box.innerHTML = "";
    matches.forEach(city => {
      let div = document.createElement("div");
      div.textContent = city;
      div.onclick = () => {
        document.getElementById("searchCity").value = city;
        box.style.display = "none";
      };
      box.appendChild(div);
    });

    box.style.display = "block";
  }

  async function loadProperties() {
    const { data, error } = await supabaseClient
      .from("properties")
      .select("*")
      .order("created_at", { ascending: false });

    if (error) {
      console.error("Error loading properties:", error);
      return;
    }

    allProperties = data || [];
    renderProperties(allProperties);
  }

  function renderProperties(list) {
    const container = document.getElementById("properties");
    container.innerHTML = "";

    if (!list || list.length === 0) {
      container.innerHTML = "<p>No properties found.</p>";
      return;
    }

    list.forEach((p) => {
      container.innerHTML += `
        <div class="card">
          <div class="card-img">
            <img src="${(p.images && p.images[0]) || p.image_url || 'https://via.placeholder.com/400'}" alt="Property">
            <span class="badge">Verified</span>
          </div>
          <div class="card-body">
            <div class="price">‚Çπ${p.price || p.rent || 0}</div>
            <div class="location">üìç ${(p.city || "")}${p.state ? ", " + p.state : ""}</div>
            <div class="details">
              <span>üõèÔ∏è ${p.bhk || "N/A"}</span>
              <span>üè† ${p.type || "Property"}</span>
              <span>üõãÔ∏è ${p.furnishing || "N/A"}</span>
            </div>
            <button class="view-btn">View Details</button>
          </div>
        </div>
      `;
    });
  }

  function applyFilters() {
    let city = document.getElementById("searchCity").value.toLowerCase();
    let type = document.getElementById("filterType").value;
    let bhk = document.getElementById("filterBHK").value;
    let budget = document.getElementById("filterBudget").value;
    let furnishing = document.getElementById("filterFurnishing").value;

    let filtered = allProperties.filter((p) => {
      const price = p.price || p.rent || 0;
      const bhkValue = p.bhk && typeof p.bhk === "string" ? p.bhk : (p.bhk ? p.bhk + " BHK" : "");

      return (
        (city === "" || (p.city || "").toLowerCase().startsWith(city)) &&
        (type === "" || p.type === type) &&
        (bhk === "" || bhkValue === bhk) &&
        (budget === "" || price >= parseInt(budget)) &&
        (furnishing === "" || p.furnishing === furnishing)
      );
    });

    renderProperties(filtered);
  }

  // HEADER BUTTONS
  async function updateHeaderButtons() {
    const nav = document.getElementById("navButtons");
    const { data } = await supabaseClient.auth.getSession();
    currentUser = data.session ? data.session.user : null;

    if (!currentUser) {
      nav.innerHTML = `
        <button class="btn-outline" onclick="openLoginModal()">Login</button>
        <button class="btn-primary" onclick="openSignupModal()">Sign Up</button>
      `;
    } else {
      const emailVerified = currentUser.email_confirmed_at || currentUser.confirmed_at;
      if (emailVerified) {
        nav.innerHTML = `
          <button class="btn-primary" onclick="openAddModal()">+ Add Property</button>
          <button class="btn-outline" onclick="logout()">Logout</button>
        `;
      } else {
        nav.innerHTML = `
          <button class="btn-outline" disabled>Email not verified</button>
          <button class="btn-outline" onclick="logout()">Logout</button>
        `;
      }
    }
  }

  async function logout() {
    await supabaseClient.auth.signOut();
    currentUser = null;
    await updateHeaderButtons();
    showToast("Logged out");
  }

  // LOGIN / SIGNUP MODALS
  function openLoginModal() {
    document.getElementById("loginModal").style.display = "flex";
  }
  function closeLoginModal() {
    document.getElementById("loginModal").style.display = "none";
  }
  function openSignupModal() {
    document.getElementById("signupModal").style.display = "flex";
  }
  function closeSignupModal() {
    document.getElementById("signupModal").style.display = "none";
  }
  function switchToSignup() {
    closeLoginModal();
    openSignupModal();
  }
  function switchToLogin() {
    closeSignupModal();
    openLoginModal();
  }

  async function login() {
    const email = document.getElementById("loginEmail").value;
    const password = document.getElementById("loginPassword").value;
    const status = document.getElementById("loginStatus");
    status.textContent = "Logging in...";

    const { error } = await supabaseClient.auth.signInWithPassword({ email, password });

    if (error) {
      status.textContent = "Invalid login";
    } else {
      status.textContent = "";
      closeLoginModal();
      showToast("Logged in");
      await updateHeaderButtons();
    }
  }

  async function signup() {
    const email = document.getElementById("signupEmail").value;
    const password = document.getElementById("signupPassword").value;
    const status = document.getElementById("signupStatus");
    status.textContent = "Creating account...";

    const { error } = await supabaseClient.auth.signUp({
      email,
      password,
      options: {
        emailRedirectTo: "https://livyro.com/email-verified.html"
      }
    });

    if (error) {
      status.textContent = "Error: " + error.message;
    } else {
      status.textContent = "Check your email to verify your account.";
    }
  }

  // ADD PROPERTY MODAL
  function openAddModal() {
    if (!currentUser) {
      showToast("Please login first");
      return;
    }
    const emailVerified = currentUser.email_confirmed_at || currentUser.confirmed_at;
    if (!emailVerified) {
      showToast("Please verify your email to add properties");
      return;
    }

    document.getElementById("addCity").value = "";
    document.getElementById("addBHK").value = "";
    document.getElementById("addRent").value = "";
    document.getElementById("addSize").value = "";
    document.getElementById("addFurnishing").value = "";
    document.getElementById("addDescription").value = "";
    document.getElementById("addImageUpload").value = "";
    document.getElementById("addPreview").style.display = "none";
    document.getElementById("addStatus").textContent = "";

    document.getElementById("addModal").style.display = "flex";
  }

  function closeAddModal() {
    document.getElementById("addModal").style.display = "none";
  }

  document.getElementById("addImageUpload").addEventListener("change", function () {
    const file = this.files[0];
    const preview = document.getElementById("addPreview");
    if (file) {
      preview.src = URL.createObjectURL(file);
      preview.style.display = "block";
    } else {
      preview.style.display = "none";
    }
  });

  async function addProperty() {
    if (!currentUser) {
      showToast("Please login first");
      return;
    }

    const emailVerified = currentUser.email_confirmed_at || currentUser.confirmed_at;
    if (!emailVerified) {
      showToast("Please verify your email to add properties");
      return;
    }

    const city = document.getElementById("addCity").value;
    const bhk = parseInt(document.getElementById("addBHK").value) || null;
    const rent = parseInt(document.getElementById("addRent").value) || null;
    const size = parseInt(document.getElementById("addSize").value) || null;
    const furnishing = document.getElementById("addFurnishing").value;
    const description = document.getElementById("addDescription").value;
    const imageFile = document.getElementById("addImageUpload").files[0];
    const statusText = document.getElementById("addStatus");

    let imageUrl = null;

    if (imageFile) {
      statusText.textContent = "Uploading image...";
      const fileName = `${currentUser.id}-${Date.now()}-${imageFile.name}`;
      const { error: uploadError } = await supabaseClient.storage.from("property-images").upload(fileName, imageFile);
      if (!uploadError) {
        const { data } = supabaseClient.storage.from("property-images").getPublicUrl(fileName);
        imageUrl = data.publicUrl;
      } else {
        statusText.textContent = "Image upload failed.";
      }
    }

    const title = `${bhk || ""} BHK ‚Ä¢ ${furnishing || ""}`.trim();

    const { error } = await supabaseClient.from("properties").insert({
      owner_id: currentUser.id,
      title,
      city,
      bhk,
      rent,
      size,
      furnishing,
      description,
      amenities: [],
      images: imageUrl ? [imageUrl] : []
    });

    if (error) {
      statusText.textContent = "Error adding property.";
    } else {
      statusText.textContent = "Property added!";
      showToast("Property added");
      loadProperties();
      setTimeout(closeAddModal, 800);
    }
  }

  // REALTIME
  supabaseClient
    .channel("properties-realtime")
    .on(
      "postgres_changes",
      { event: "*", schema: "public", table: "properties" },
      () => loadProperties()
    )
    .subscribe();

  // INIT
  (async () => {
    await updateHeaderButtons();
    await loadProperties();
  })();
</script>

</body>
</html>
