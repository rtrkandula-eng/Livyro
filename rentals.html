<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Livyro Rentals</title>

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: "Inter", sans-serif;
    }

    body {
      background: #fafafa;
      color: #222;
    }

    .primary-btn {
      background: #4a3aff;
      color: white;
      padding: 8px 16px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      font-weight: 600;
      transition: 0.2s;
    }

    .primary-btn:hover {
      background: #372bdb;
    }

    .secondary-btn {
      background: #e8e8e8;
      color: #333;
      padding: 8px 16px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      font-weight: 500;
      transition: 0.2s;
    }

    .secondary-btn:hover {
      background: #d5d5d5;
    }

    .icon-btn {
      background: none;
      border: none;
      font-size: 22px;
      cursor: pointer;
      margin-right: 12px;
    }

    .hidden {
      display: none !important;
    }

    .header {
      width: 100%;
      padding: 16px 40px;
      background: white;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid #eee;
      position: sticky;
      top: 0;
      z-index: 50;
    }

    .logo {
      font-size: 24px;
      font-weight: 800;
      color: #4a3aff;
    }

    .nav-links a {
      margin: 0 12px;
      text-decoration: none;
      color: #444;
      font-weight: 500;
    }

    .nav-links a:hover {
      color: #4a3aff;
    }

    .header-actions {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .profile-container {
      position: relative;
      cursor: pointer;
    }

    .profile-icon {
      width: 32px;
      height: 32px;
      fill: #333;
      transition: 0.2s;
    }

    .profile-icon:hover {
      fill: #4a3aff;
    }

    .dropdown {
      position: absolute;
      top: 42px;
      right: 0;
      background: white;
      border: 1px solid #ddd;
      border-radius: 8px;
      width: 180px;
      box-shadow: 0 4px 14px rgba(0,0,0,0.1);
      padding: 6px 0;
      animation: fadeIn 0.15s ease-out;
      z-index: 100;
    }

    .dropdown-item {
      width: 100%;
      padding: 10px 14px;
      text-align: left;
      background: none;
      border: none;
      cursor: pointer;
      font-size: 14px;
    }

    .dropdown-item:hover {
      background: #f5f5f5;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-4px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .rentals-section {
      padding: 40px;
    }

    .rentals-section h2 {
      font-size: 28px;
      margin-bottom: 20px;
    }

    .property-list {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(290px, 1fr));
      gap: 24px;
    }

    .property-card {
      background: white;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 4px 14px rgba(0,0,0,0.08);
      transition: 0.2s;
    }

    .property-card:hover {
      transform: translateY(-4px);
    }

    .property-image {
      width: 100%;
      height: 180px;
      object-fit: cover;
    }

    .property-info {
      padding: 16px;
    }

    .property-info h3 {
      font-size: 18px;
      margin-bottom: 6px;
    }

    .property-info p {
      font-size: 14px;
      color: #555;
      margin-bottom: 4px;
    }

    .card-actions {
      display: flex;
      justify-content: space-between;
      padding: 12px 16px;
      border-top: 1px solid #eee;
      align-items: center;
      gap: 8px;
    }

    .save-btn {
      background: none;
      border: none;
      font-size: 22px;
      cursor: pointer;
      transition: 0.2s;
    }

    .save-btn.saved {
      color: red;
    }

    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.45);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 200;
    }

    .modal-content {
      background: white;
      padding: 24px;
      width: 420px;
      max-width: 90%;
      border-radius: 12px;
      box-shadow: 0 4px 14px rgba(0,0,0,0.2);
      animation: fadeIn 0.2s ease-out;
    }

    .modal-content h3 {
      margin-bottom: 16px;
    }

    .modal-content input,
    .modal-content textarea {
      width: 100%;
      padding: 10px;
      margin-bottom: 12px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 14px;
    }

    .modal-content textarea {
      height: 80px;
      resize: none;
    }

    #savedHomesList,
    #myListingsList {
      max-height: 300px;
      overflow-y: auto;
      margin-bottom: 16px;
    }

    @media (max-width: 768px) {
      .header {
        padding: 12px 16px;
      }
      .rentals-section {
        padding: 20px 16px;
      }
    }
  </style>
</head>

<body>
  <!-- ========================= HEADER ========================= -->
  <header class="header">
    <div class="logo">LIVYRO</div>

    <nav class="nav-links">
      <a href="/">Home</a>
      <a href="/rentals">Rentals</a>
      <a href="/services">Services</a>
    </nav>

    <div class="header-actions">
      <!-- Tenant quick icon -->
      <button id="savedHomesBtn" class="icon-btn hidden">❤️</button>

      <!-- Owner quick button -->
      <button id="addPropertyBtn" class="primary-btn hidden">+ Add Property</button>

      <!-- Profile -->
      <div class="profile-container hidden" id="profileContainer">
        <svg id="profileIcon" class="profile-icon" viewBox="0 0 24 24">
          <path fill="#333"
            d="M12 12c2.7 0 5-2.3 5-5s-2.3-5-5-5-5 2.3-5 5 2.3 5 5 5zm0 2c-3.3 0-10 1.7-10 5v3h20v-3c0-3.3-6.7-5-10-5z" />
        </svg>

        <div id="profileDropdown" class="dropdown hidden">
          <button id="dropdownSavedHomes" class="dropdown-item hidden">Saved Homes</button>
          <button id="dropdownMyListings" class="dropdown-item hidden">My Listings</button>
          <button id="dropdownAddProperty" class="dropdown-item hidden">Add Property</button>
          <button id="dropdownLogout" class="dropdown-item">Logout</button>
        </div>
      </div>

      <!-- Auth buttons -->
      <button id="loginBtn" class="secondary-btn">Login</button>
      <button id="signupBtn" class="primary-btn">Sign Up</button>
    </div>
  </header>

  <!-- ========================= PROPERTY LIST ========================= -->
  <section class="rentals-section">
    <h2>Available Rentals</h2>
    <div id="propertyList" class="property-list"></div>
  </section>

  <!-- ========================= MODALS ========================= -->
  <div id="addPropertyModal" class="modal hidden">
    <div class="modal-content">
      <h3>Add Property</h3>
      <input id="propTitle" placeholder="Title" />
      <input id="propCity" placeholder="City" />
      <input id="propBHK" type="number" placeholder="BHK" />
      <input id="propRent" type="number" placeholder="Rent (₹)" />
      <input id="propSize" type="number" placeholder="Size (sqft)" />
      <input id="propFurnishing" placeholder="Furnishing" />
      <textarea id="propDescription" placeholder="Description"></textarea>
      <input id="propAmenities" placeholder="Amenities (comma separated)" />
      <input id="propImages" placeholder="Image URLs (comma separated)" />
      <button id="submitProperty" class="primary-btn">Submit</button>
      <button class="secondary-btn closeModal">Cancel</button>
    </div>
  </div>

  <div id="savedHomesModal" class="modal hidden">
    <div class="modal-content">
      <h3>Saved Homes</h3>
      <div id="savedHomesList"></div>
      <button class="secondary-btn closeModal">Close</button>
    </div>
  </div>

  <div id="myListingsModal" class="modal hidden">
    <div class="modal-content">
      <h3>My Listings</h3>
      <div id="myListingsList"></div>
      <button class="secondary-btn closeModal">Close</button>
    </div>
  </div>

  <div id="loginModal" class="modal hidden">
    <div class="modal-content">
      <h3>Login</h3>
      <input id="loginEmail" placeholder="Email" />
      <input id="loginPassword" type="password" placeholder="Password" />
      <button id="loginSubmit" class="primary-btn">Login</button>
      <button class="secondary-btn closeModal">Cancel</button>
    </div>
  </div>

  <div id="signupModal" class="modal hidden">
    <div class="modal-content">
      <h3>Sign Up</h3>
      <input id="signupEmail" placeholder="Email" />
      <input id="signupPassword" type="password" placeholder="Password" />
      <button id="signupSubmit" class="primary-btn">Sign Up</button>
      <button class="secondary-btn closeModal">Cancel</button>
    </div>
  </div>

  <!-- ========================= JS ========================= -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const supabaseClient = supabase.createClient(
      "https://ehzwbbypvccuhfhvukpp.supabase.co",
      "PASTE_YOUR_ANON_KEY_HERE"
    );

    let currentUser = null;
    let currentRole = null;

    const qs = (id) => document.getElementById(id);

    function openModal(id) {
      qs(id).classList.remove("hidden");
    }

    function closeAllModals() {
      document.querySelectorAll(".modal").forEach(m => m.classList.add("hidden"));
    }

    document.querySelectorAll(".closeModal").forEach(btn => {
      btn.addEventListener("click", closeAllModals);
    });

    async function checkSession() {
      const { data } = await supabaseClient.auth.getSession();
      currentUser = data.session?.user || null;

      if (currentUser) {
        qs("loginBtn").classList.add("hidden");
        qs("signupBtn").classList.add("hidden");
        qs("profileContainer").classList.remove("hidden");
        await loadUserRole();
      } else {
        qs("loginBtn").classList.remove("hidden");
        qs("signupBtn").classList.remove("hidden");
        qs("profileContainer").classList.add("hidden");
      }
    }

    async function loadUserRole() {
      const { data } = await supabaseClient
        .from("profiles")
        .select("role")
        .eq("id", currentUser.id)
        .maybeSingle();

      currentRole = data?.role || null;
      updateHeaderUI();
    }

    function updateHeaderUI() {
      const savedBtn = qs("savedHomesBtn");
      const addBtn = qs("addPropertyBtn");
      const ddSaved = qs("dropdownSavedHomes");
      const ddListings = qs("dropdownMyListings");
      const ddAdd = qs("dropdownAddProperty");

      [savedBtn, addBtn, ddSaved, ddListings, ddAdd].forEach(el => el.classList.add("hidden"));

      if (currentRole === "tenant") {
        savedBtn.classList.remove("hidden");
        ddSaved.classList.remove("hidden");
      }

      if (currentRole === "owner") {
        addBtn.classList.remove("hidden");
        ddListings.classList.remove("hidden");
        ddAdd.classList.remove("hidden");
      }
    }

    async function loadProperties() {
      const { data, error } = await supabaseClient
        .from("properties")
        .select("*")
        .order("created_at", { ascending: false });

      if (error) {
        console.error(error);
        return;
      }

      const container = qs("propertyList");
      container.innerHTML = "";

      (data || []).forEach(p => {
        const card = document.createElement("div");
        card.className = "property-card";

        const img = (p.images && p.images[0]) || "https://via.placeholder.com/400x250?text=Livyro";

        card.innerHTML = `
          <img src="${img}" class="property-image" />
          <div class="property-info">
            <h3>${p.title || "Untitled"}</h3>
            <p>${p.city || ""}</p>
            <p>${p.bhk || "-"} BHK • ${p.size || "-"} sqft</p>
            <p>₹${p.rent || "-"} / month</p>
          </div>
          <div class="card-actions">
            <button class="save-btn" data-id="${p.id}">❤️</button>
            <button class="primary-btn" onclick="alert('Contact flow coming soon')">Contact</button>
          </div>
        `;

        container.appendChild(card);
      });

      container.querySelectorAll(".save-btn").forEach(btn => {
        btn.addEventListener("click", async () => {
          const propertyId = btn.getAttribute("data-id");
          await handleSaveHome(propertyId, btn);
        });
      });
    }

    async function ensureTenantRole() {
      if (!currentRole || currentRole !== "tenant") {
        await supabaseClient
          .from("profiles")
          .update({ role: "tenant" })
          .eq("id", currentUser.id);
        currentRole = "tenant";
        updateHeaderUI();
      }
    }

    async function ensureOwnerRole() {
      if (!currentRole || currentRole !== "owner") {
        await supabaseClient
          .from("profiles")
          .update({ role: "owner" })
          .eq("id", currentUser.id);
        currentRole = "owner";
        updateHeaderUI();
      }
    }

    async function handleSaveHome(propertyId, btn) {
      if (!currentUser) {
        openModal("loginModal");
        return;
      }

      await ensureTenantRole();

      const { error } = await supabaseClient
        .from("saved_homes")
        .insert({
          tenant_id: currentUser.id,
          property_id: propertyId
        });

      if (error) {
        alert("Error saving home");
        console.error(error);
        return;
      }

      btn.classList.add("saved");
      alert("Home saved");
    }

    async function loadSavedHomes() {
      if (!currentUser) return;

      const { data, error } = await supabaseClient
        .from("saved_homes")
        .select("property_id, properties(*)")
        .eq("tenant_id", currentUser.id)
        .order("created_at", { ascending: false });

      if (error) {
        console.error(error);
        return;
      }

      const list = qs("savedHomesList");
      list.innerHTML = "";

      (data || []).forEach(item => {
        const p = item.properties;
        if (!p) return;
        const img = (p.images && p.images[0]) || "https://via.placeholder.com/400x250?text=Livyro";

        const div = document.createElement("div");
        div.style.marginBottom = "16px";
        div.innerHTML = `
          <img src="${img}" style="width:100%; border-radius:8px; margin-bottom:6px;" />
          <h4>${p.title || "Untitled"}</h4>
          <p>${p.city || ""}</p>
          <p>${p.bhk || "-"} BHK • ₹${p.rent || "-"} / month</p>
        `;
        list.appendChild(div);
      });
    }

    async function loadMyListings() {
      if (!currentUser) return;

      const { data, error } = await supabaseClient
        .from("properties")
        .select("*")
        .eq("owner_id", currentUser.id)
        .order("created_at", { ascending: false });

      if (error) {
        console.error(error);
        return;
      }

      const list = qs("myListingsList");
      list.innerHTML = "";

      (data || []).forEach(p => {
        const img = (p.images && p.images[0]) || "https://via.placeholder.com/400x250?text=Livyro";

        const div = document.createElement("div");
        div.style.marginBottom = "16px";
        div.innerHTML = `
          <img src="${img}" style="width:100%; border-radius:8px; margin-bottom:6px;" />
          <h4>${p.title || "Untitled"}</h4>
          <p>${p.city || ""}</p>
          <p>${p.bhk || "-"} BHK • ₹${p.rent || "-"} / month</p>
        `;
        list.appendChild(div);
      });
    }

    async function addProperty() {
      if (!currentUser) {
        openModal("loginModal");
        return;
      }

      await ensureOwnerRole();

      const title = qs("propTitle").value.trim();
      const city = qs("propCity").value.trim();
      const bhk = parseInt(qs("propBHK").value || "0", 10);
      const rent = parseInt(qs("propRent").value || "0", 10);
      const size = parseInt(qs("propSize").value || "0", 10);
      const furnishing = qs("propFurnishing").value.trim();
      const description = qs("propDescription").value.trim();
      const amenities = qs("propAmenities").value
        .split(",")
        .map(a => a.trim())
        .filter(a => a.length > 0);
      const images = qs("propImages").value
        .split(",")
        .map(i => i.trim())
        .filter(i => i.length > 0);

      const { error } = await supabaseClient
        .from("properties")
        .insert({
          owner_id: currentUser.id,
          title,
          city,
          bhk,
          rent,
          size,
          furnishing,
          description,
          amenities,
          images
        });

      if (error) {
        alert("Error adding property");
        console.error(error);
        return;
      }

      alert("Property added");
      closeAllModals();
      loadProperties();
    }

    async function handleLogin() {
      const email = qs("loginEmail").value.trim();
      const password = qs("loginPassword").value;

      const { error } = await supabaseClient.auth.signInWithPassword({ email, password });
      if (error) {
        alert(error.message);
        return;
      }

      closeAllModals();
      await checkSession();
      await loadProperties();
    }

    async function handleSignup() {
      const email = qs("signupEmail").value.trim();
      const password = qs("signupPassword").value;

      const { data, error } = await supabaseClient.auth.signUp({ email, password });
      if (error) {
        alert(error.message);
        return;
      }

      if (data.user) {
        await supabaseClient.from("profiles").insert({
          id: data.user.id,
          email: email,
          role: null
        });
      }

      closeAllModals();
      await checkSession();
      await loadProperties();
    }

    async function handleLogout() {
      await supabaseClient.auth.signOut();
      currentUser = null;
      currentRole = null;
      closeAllModals();
      await checkSession();
      await loadProperties();
    }

    function setupHeaderEvents() {
      qs("loginBtn").addEventListener("click", () => openModal("loginModal"));
      qs("signupBtn").addEventListener("click", () => openModal("signupModal"));

      qs("savedHomesBtn").addEventListener("click", async () => {
        await loadSavedHomes();
        openModal("savedHomesModal");
      });

      qs("addPropertyBtn").addEventListener("click", () => openModal("addPropertyModal"));

      qs("dropdownSavedHomes").addEventListener("click", async () => {
        closeDropdown();
        await loadSavedHomes();
        openModal("savedHomesModal");
      });

      qs("dropdownMyListings").addEventListener("click", async () => {
        closeDropdown();
        await loadMyListings();
        openModal("myListingsModal");
      });

      qs("dropdownAddProperty").addEventListener("click", () => {
        closeDropdown();
        openModal("addPropertyModal");
      });

      qs("dropdownLogout").addEventListener("click", async () => {
        closeDropdown();
        await handleLogout();
      });

      qs("profileIcon").addEventListener("click", (e) => {
        e.stopPropagation();
        toggleDropdown();
      });

      document.addEventListener("click", () => {
        closeDropdown();
      });

      qs("profileDropdown").addEventListener("click", (e) => {
        e.stopPropagation();
      });

      qs("submitProperty").addEventListener("click", addProperty);
      qs("loginSubmit").addEventListener("click", handleLogin);
      qs("signupSubmit").addEventListener("click", handleSignup);
    }

    function toggleDropdown() {
      qs("profileDropdown").classList.toggle("hidden");
    }

    function closeDropdown() {
      qs("profileDropdown").classList.add("hidden");
    }

    (async function init() {
      setupHeaderEvents();
      await checkSession();
      await loadProperties();
    })();
  </script>
</body>
</html>
