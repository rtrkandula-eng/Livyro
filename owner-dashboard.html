<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Owner Dashboard – Livyro</title>
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>

<style>
body {
    background: #f8f8f8;
    font-family: Poppins, sans-serif;
}

.dashboard {
    max-width: 900px;
    margin: 40px auto;
    padding: 20px;
}

.top-bar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 30px;
}

.top-bar h2 {
    font-size: 28px;
    font-weight: 700;
}

.logout-btn {
    padding: 10px 18px;
    background: #eee;
    border-radius: 8px;
    cursor: pointer;
}

.section-title {
    font-size: 20px;
    margin: 20px 0 10px;
}

.property-list {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
    gap: 20px;
}

.property-card {
    background: #fff;
    padding: 16px;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    border: 1px solid rgba(148,163,184,0.25);
}

.property-card img {
    width: 100%;
    height: 160px;
    object-fit: cover;
    border-radius: 8px;
    margin-bottom: 10px;
}

.card-actions {
    display: flex;
    justify-content: space-between;
    margin-top: 10px;
}

.edit-btn {
    padding: 8px 14px;
    background: #6A0DAD;
    color: white;
    border-radius: 6px;
    cursor: pointer;
    font-size: 13px;
}

.delete-btn {
    padding: 8px 14px;
    background: #ffdddd;
    color: #b30000;
    border-radius: 6px;
    cursor: pointer;
    font-size: 13px;
}

/* ADD PROPERTY BOX */
.add-box {
    margin-top: 40px;
    padding: 20px;
    background: #fff;
    border-radius: 16px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
}

.add-box input,
.add-box select,
.add-box textarea {
    width: 100%;
    padding: 12px;
    margin-bottom: 12px;
    border-radius: 10px;
    border: 1px solid rgba(148,163,184,0.6);
}

.btn-primary {
    padding: 12px 20px;
    background: #6A0DAD;
    color: #fff;
    border-radius: 999px;
    cursor: pointer;
    border: none;
}

/* EDIT MODAL */
.modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.55);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 20;
}

.modal-content {
    background: white;
    padding: 25px;
    width: 400px;
    border-radius: 14px;
}

.modal-content input,
.modal-content select,
.modal-content textarea {
    width: 100%;
    padding: 12px;
    margin-bottom: 12px;
    border-radius: 10px;
    border: 1px solid #ccc;
}

.save-btn {
    background: #6A0DAD;
    color: white;
    padding: 12px;
    width: 100%;
    border-radius: 10px;
    cursor: pointer;
}

.close-btn {
    text-align: right;
    cursor: pointer;
    font-size: 18px;
    margin-bottom: 10px;
}

/* TOAST */
.toast {
    position: fixed;
    bottom: 20px;
    right: 20px;
    background: #6A0DAD;
    color: white;
    padding: 12px 18px;
    border-radius: 8px;
    display: none;
}
</style>
</head>

<body>

<div class="dashboard">

    <div class="top-bar">
        <h2>Owner Dashboard</h2>
        <div class="logout-btn" id="logoutBtn">Logout</div>
    </div>

    <h3 class="section-title">Your Properties</h3>
    <div id="propertyList" class="property-list"></div>

    <!-- ADD PROPERTY -->
    <div class="add-box">
        <h3>Add New Property</h3>

        <input type="text" id="city" placeholder="City">
        <select id="bhk">
            <option value="">BHK</option>
            <option value="1">1 BHK</option>
            <option value="2">2 BHK</option>
            <option value="3">3 BHK</option>
            <option value="4">4 BHK+</option>
        </select>
        <input type="number" id="rent" placeholder="Rent (₹)">
        <input type="number" id="size" placeholder="Size (sqft)">
        <select id="furnishing">
            <option value="">Furnishing</option>
            <option>Fully Furnished</option>
            <option>Semi Furnished</option>
            <option>Unfurnished</option>
        </select>
        <textarea id="description" placeholder="Description"></textarea>

        <input type="file" id="imageUpload" accept="image/*">
        <p id="uploadStatus"></p>

        <button class="btn-primary" id="addBtn">Add Property</button>
        <p id="addStatus"></p>
    </div>

</div>

<!-- EDIT MODAL -->
<div class="modal" id="editModal">
    <div class="modal-content">
        <div class="close-btn" onclick="closeModal()">✖</div>

        <h3>Edit Property</h3>

        <input type="text" id="editCity">
        <input type="number" id="editRent">
        <input type="number" id="editSize">
        <select id="editFurnishing">
            <option>Fully Furnished</option>
            <option>Semi Furnished</option>
            <option>Unfurnished</option>
        </select>
        <textarea id="editDescription"></textarea>

        <input type="file" id="editImageUpload" accept="image/*">
        <img id="editPreview" style="width:100%;border-radius:8px;margin-bottom:10px;">

        <button class="save-btn" onclick="saveChanges()">Save Changes</button>
    </div>
</div>

<div class="toast" id="toast"></div>

<script>
const supabaseUrl = "https://ehzwbbypvccuhfhvukpp.supabase.co";
const supabaseAnonKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVoendiYnlwdmNjdWhmaHZ1a3BwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEzNTQzMzMsImV4cCI6MjA4NjkzMDMzM30.JPsDBtJVw-lrlr8Y2ipioNQtc80DZ0v1wKcPtz0ixzI";
const supabase = window.supabase.createClient(supabaseUrl, supabaseAnonKey);

let ownerId = null;
let editingPropertyId = null;

/* TOAST */
function showToast(msg) {
    const t = document.getElementById("toast");
    t.textContent = msg;
    t.style.display = "block";
    setTimeout(() => t.style.display = "none", 2500);
}

/* CHECK LOGIN */
async function checkSession() {
    const { data } = await supabase.auth.getSession();
    if (!data.session) {
        window.location.href = "owner-login.html";
        return;
    }
    ownerId = data.session.user.id;
    loadProperties();
}
checkSession();

/* LOAD PROPERTIES */
async function loadProperties() {
    const list = document.getElementById("propertyList");
    list.innerHTML = "Loading...";

    const { data, error } = await supabase
        .from("properties")
        .select("*")
        .eq("owner_id", ownerId)
        .order("created_at", { ascending: false });

    if (error) {
        list.innerHTML = "Error loading properties.";
        return;
    }

    if (!data.length) {
        list.innerHTML = "<p>You have no properties yet.</p>";
        return;
    }

    list.innerHTML = "";
    data.forEach(p => {
        const card = document.createElement("div");
        card.className = "property-card";
        card.innerHTML = `
            <img src="${p.images?.[0] || 'https://via.placeholder.com/300'}">
            <h3>${p.title}</h3>
            <p>${p.city} • ${p.size} sqft</p>
            <p>₹${p.rent} / month</p>

            <div class="card-actions">
                <div class="edit-btn" onclick='openEditModal(${JSON.stringify(p)})'>Edit</div>
                <div class="delete-btn" onclick="deleteProperty('${p.id}')">Delete</div>
            </div>
        `;
        list.appendChild(card);
    });
}

/* OPEN EDIT MODAL */
function openEditModal(p) {
    editingPropertyId = p.id;

    document.getElementById("editCity").value = p.city;
    document.getElementById("editRent").value = p.rent;
    document.getElementById("editSize").value = p.size;
    document.getElementById("editFurnishing").value = p.furnishing;
    document.getElementById("editDescription").value = p.description;
    document.getElementById("editPreview").src = p.images?.[0] || "";

    document.getElementById("editModal").style.display = "flex";
}

/* CLOSE MODAL */
function closeModal() {
    document.getElementById("editModal").style.display = "none";
}

/* SAVE CHANGES */
async function saveChanges() {
    const city = document.getElementById("editCity").value;
    const rent = parseInt(document.getElementById("editRent").value);
    const size = parseInt(document.getElementById("editSize").value);
    const furnishing = document.getElementById("editFurnishing").value;
    const description = document.getElementById("editDescription").value;

    let newImageUrl = null;
    const file = document.getElementById("editImageUpload").files[0];

    if (file) {
        const fileName = `${ownerId}-${Date.now()}-${file.name}`;
        await supabase.storage.from("property-images").upload(fileName, file);
        const { data } = supabase.storage.from("property-images").getPublicUrl(fileName);
        newImageUrl = data.publicUrl;
    }

    const updateData = {
        city, rent, size, furnishing, description
    };

    if (newImageUrl) updateData.images = [newImageUrl];

    await supabase.from("properties").update(updateData).eq("id", editingPropertyId);

    closeModal();
    showToast("Property updated!");
    loadProperties();
}

/* DELETE PROPERTY */
async function deleteProperty(id) {
    await supabase.from("properties").delete().eq("id", id);
    showToast("Property deleted");
    loadProperties();
}

/* ADD PROPERTY */
document.getElementById("addBtn").addEventListener("click", async () => {
    const city = document.getElementById("city").value;
    const bhk = parseInt(document.getElementById("bhk").value);
    const rent = parseInt(document.getElementById("rent").value);
    const size = parseInt(document.getElementById("size").value);
    const furnishing = document.getElementById("furnishing").value;
    const description = document.getElementById("description").value;
    const imageFile = document.getElementById("imageUpload").files[0];

    let imageUrl = null;

    if (imageFile) {
        const fileName = `${ownerId}-${Date.now()}-${imageFile.name}`;
        await supabase.storage.from("property-images").upload(fileName, imageFile);
        const { data } = supabase.storage.from("property-images").getPublicUrl(fileName);
        imageUrl = data.publicUrl;
    }

    const title = `${bhk} BHK • ${furnishing}`;

    await supabase.from("properties").insert({
        owner_id: ownerId,
        title,
        city,
        bhk,
        rent,
        size,
        furnishing,
        description,
        amenities: [],
        images: imageUrl ? [imageUrl] : []
    });

    showToast("Property added!");
    loadProperties();
});

/* LOGOUT */
document.getElementById("logoutBtn").addEventListener("click", async () => {
    await supabase.auth.signOut();
    window.location.href = "owner-login.html";
});
</script>

</body>
</html>
