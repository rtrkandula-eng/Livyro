<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Owner Dashboard – Livyro</title>
<link rel="stylesheet" href="style.css">
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>

<style>
body {
    background: #f8f8f8;
    font-family: Arial, sans-serif;
}

.dashboard {
    max-width: 900px;
    margin: 40px auto;
    padding: 20px;
}

.top-bar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 30px;
}

.top-bar h2 {
    font-size: 28px;
    font-weight: 700;
}

.logout-btn {
    padding: 10px 18px;
    background: #eee;
    border-radius: 8px;
    cursor: pointer;
}

.section-title {
    font-size: 20px;
    margin: 20px 0 10px;
}

.property-list {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
    gap: 20px;
}

.property-card {
    background: #fff;
    padding: 16px;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    border: 1px solid rgba(148,163,184,0.25);
}

.property-card img {
    width: 100%;
    height: 160px;
    object-fit: cover;
    border-radius: 8px;
    margin-bottom: 10px;
}

.property-card h3 {
    margin-bottom: 6px;
}

.property-card p {
    font-size: 14px;
    color: #666;
}

.delete-btn {
    margin-top: 10px;
    padding: 8px 14px;
    background: #ffdddd;
    color: #b30000;
    border-radius: 6px;
    cursor: pointer;
    font-size: 13px;
}

.add-box {
    margin-top: 40px;
    padding: 20px;
    background: #fff;
    border-radius: 16px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
}

.add-box input,
.add-box select,
.add-box textarea {
    width: 100%;
    padding: 12px;
    margin-bottom: 12px;
    border-radius: 10px;
    border: 1px solid rgba(148,163,184,0.6);
}

.btn-primary {
    padding: 12px 20px;
    background: #6A0DAD;
    color: #fff;
    border-radius: 999px;
    cursor: pointer;
    border: none;
}
</style>
</head>

<body>

<div class="dashboard">

    <div class="top-bar">
        <h2>Owner Dashboard</h2>
        <div class="logout-btn" id="logoutBtn">Logout</div>
    </div>

    <h3 class="section-title">Your Properties</h3>
    <div id="propertyList" class="property-list"></div>

    <div class="add-box">
        <h3>Add New Property</h3>

        <input type="text" id="city" placeholder="City">
        <select id="bhk">
            <option value="">BHK</option>
            <option value="1">1 BHK</option>
            <option value="2">2 BHK</option>
            <option value="3">3 BHK</option>
            <option value="4">4 BHK+</option>
        </select>
        <input type="number" id="rent" placeholder="Rent (₹)">
        <input type="number" id="size" placeholder="Size (sqft)">
        <select id="furnishing">
            <option value="">Furnishing</option>
            <option>Fully Furnished</option>
            <option>Semi Furnished</option>
            <option>Unfurnished</option>
        </select>
        <textarea id="description" placeholder="Description"></textarea>

        <input type="file" id="imageUpload" accept="image/*">
        <p id="uploadStatus" style="font-size:14px;color:#666;"></p>

        <button class="btn-primary" id="addBtn">Add Property</button>
        <p id="addStatus" style="margin-top:10px;color:#666;"></p>
    </div>

</div>

<script>
const supabaseUrl = "https://ehzwbbypvccuhfhvukpp.supabase.co";
const supabaseAnonKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVoendiYnlwdmNjdWhmaHZ1a3BwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEzNTQzMzMsImV4cCI6MjA4NjkzMDMzM30.JPsDBtJVw-lrlr8Y2ipioNQtc80DZ0v1wKcPtz0ixzI";
const supabase = window.supabase.createClient(supabaseUrl, supabaseAnonKey);

let ownerId = null;

// CHECK LOGIN
async function checkSession() {
    const { data } = await supabase.auth.getSession();
    if (!data.session) {
        window.location.href = "owner-login.html";
        return;
    }
    ownerId = data.session.user.id;
    loadProperties();
}
checkSession();

// UPLOAD IMAGE
async function uploadImage(file) {
    const fileName = `${ownerId}-${Date.now()}-${file.name}`;
    const { data, error } = await supabase.storage
        .from("property-images")
        .upload(fileName, file);

    if (error) {
        console.error(error);
        return null;
    }

    const { data: urlData } = supabase.storage
        .from("property-images")
        .getPublicUrl(fileName);

    return urlData.publicUrl;
}

// LOAD PROPERTIES
async function loadProperties() {
    const list = document.getElementById("propertyList");
    list.innerHTML = "Loading...";

    const { data, error } = await supabase
        .from("properties")
        .select("*")
        .eq("owner_id", ownerId)
        .order("created_at", { ascending: false });

    if (error) {
        list.innerHTML = "Error loading properties.";
        return;
    }

    if (!data.length) {
        list.innerHTML = "<p>You have no properties yet.</p>";
        return;
    }

    list.innerHTML = "";
    data.forEach(p => {
        const card = document.createElement("div");
        card.className = "property-card";
        card.innerHTML = `
            <img src="${p.images?.[0] || 'https://via.placeholder.com/300'}">
            <h3>${p.title}</h3>
            <p>${p.city} • ${p.size} sqft</p>
            <p>₹${p.rent} / month</p>
            <div class="delete-btn" data-id="${p.id}">Delete</div>
        `;
        card.querySelector(".delete-btn").addEventListener("click", () => deleteProperty(p.id));
        list.appendChild(card);
    });
}

// DELETE PROPERTY
async function deleteProperty(id) {
    await supabase.from("properties").delete().eq("id", id);
    loadProperties();
}

// ADD PROPERTY
document.getElementById("addBtn").addEventListener("click", async () => {
    const city = document.getElementById("city").value;
    const bhk = parseInt(document.getElementById("bhk").value);
    const rent = parseInt(document.getElementById("rent").value);
    const size = parseInt(document.getElementById("size").value);
    const furnishing = document.getElementById("furnishing").value;
    const description = document.getElementById("description").value;
    const imageFile = document.getElementById("imageUpload").files[0];

    const status = document.getElementById("addStatus");
    const uploadStatus = document.getElementById("uploadStatus");

    let imageUrl = null;

    if (imageFile) {
        uploadStatus.textContent = "Uploading image...";
        imageUrl = await uploadImage(imageFile);
        uploadStatus.textContent = imageUrl ? "Image uploaded!" : "Image upload failed.";
    }

    const title = `${bhk} BHK • ${furnishing}`;

    const { error } = await supabase.from("properties").insert({
        owner_id: ownerId,
        title,
        city,
        bhk,
        rent,
        size,
        furnishing,
        description,
        amenities: [],
        images: imageUrl ? [imageUrl] : []
    });

    if (error) {
        status.textContent = "Error adding property.";
    } else {
        status.textContent = "Property added!";
        loadProperties();
    }
});

// LOGOUT
document.getElementById("logoutBtn").addEventListener("click", async () => {
    await supabase.auth.signOut();
    window.location.href = "owner-login.html";
});
</script>

</body>
</html>